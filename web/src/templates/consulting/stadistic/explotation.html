{% extends "ui/app.html" %}

{% load i18n %}
{% load l10n %}
{% load stadistic %}

{% block css_files %}
  {{block.super}}
  <style>
.shared, .bar, .label {
  font-size: 8pt;
  font-weight: bold;
  font-family: Arial, sans-serif;
}
.femalebar {
  fill: #F47777;
  }
.malebar {
  fill: #77F4D7;
}
.highlight rect.malebar, .highlight rect.femalebar {
  fill: #007ACC;
}
text.malebar, text.femalebar {
  display: none;
}
.highlight text {
  display: block;
  fill: #000;
}
</style>
{% endblock %}

{% block js_files %}
  {{ block.super }}
  <script src="http://d3js.org/d3.v2.js"></script>
{% endblock %}

{% block jquery_init %}
$('#main').remove();
$('#right_bar').remove();

var data = [
  {% for labelname, values in data.items %}
    {% localize off %}
      {"sharedLabel": "{{labelname}}", "barData1": {% if values.1 %}{{values.1|unlocalize}}{% else %}0{% endif %}, "barData2": {% if values.2 %}{{values.2|unlocalize}}{% else %}0{% endif %}},
    {% endlocalize %}
  {% endfor %}
];

/* edit these settings freely */  
var w = 600,
    h = 400,
    topMargin = 15,
    labelSpace = 120,
    innerMargin = w/2+labelSpace,
    outerMargin = 15,
    gap = 2,
    dataRange = d3.max(data.map(function(d) { return Math.max(d.barData1, d.barData2) }));
    leftLabel = "Mujeres",
    rightLabel = "Hombres";

/* edit with care */
var chartWidth = w - innerMargin - outerMargin,
    barWidth = h / data.length,
    yScale = d3.scale.linear().domain([0, data.length]).range([0, h-topMargin]),
    total = d3.scale.linear().domain([0, dataRange]).range([0, chartWidth - labelSpace/2]),
    commas = d3.format(",.3f");

/* main panel */
var vis = d3.select("#vis").append("svg")
    .attr("width", w)
    .attr("height", h);

/* barData1 label */
vis.append("text")
  .attr("class", "label")
  .text(leftLabel)
  .attr("x", w-innerMargin)
  .attr("y", topMargin-3)
  .attr("text-anchor", "end");

/* barData2 label */
vis.append("text")
  .attr("class", "label")
  .text(rightLabel)
  .attr("x", innerMargin)
  .attr("y", topMargin-3);

/* female bars and data labels */ 
var bar = vis.selectAll("g.bar")
    .data(data)
  .enter().append("g")
    .attr("class", "bar")
    .attr("transform", function(d, i) {
      return "translate(0," + (yScale(i) + topMargin) + ")";
    });

var wholebar = bar.append("rect")
    .attr("width", w)
    .attr("height", barWidth-gap)
    .attr("fill", "none")
    .attr("pointer-events", "all");

var highlight = function(c) {
  return function(d, i) {
    bar.filter(function(d, j) {
      return i === j;
    }).attr("class", c);
  };
};

bar
  .on("mouseover", highlight("highlight bar"))
  .on("mouseout", highlight("bar"));

bar.append("rect")
    .attr("class", "femalebar")
    .attr("height", barWidth-gap);

bar.append("text")
    .attr("class", "femalebar")
    .attr("dx", -3)
    .attr("dy", "1em")
    .attr("text-anchor", "end");

bar.append("rect")
    .attr("class", "malebar")
    .attr("height", barWidth-gap)
    .attr("x", innerMargin);

bar.append("text")
    .attr("class", "malebar")
    .attr("dx", 3)
    .attr("dy", "1em");

/* sharedLabels */
bar.append("text")
    .attr("class", "shared")
    .attr("x", w/2)
    .attr("dy", "1em")
    .attr("text-anchor", "middle")
    .text(function(d) { return d.sharedLabel; });

refresh(data);

function refresh(data) {
  var bars = d3.selectAll("g.bar")
      .data(data);
  bars.selectAll("rect.malebar")
    .transition()
      .attr("width", function(d) { return total(d.barData1); });
  bars.selectAll("rect.femalebar")
    .transition()
      .attr("x", function(d) { return innerMargin - total(d.barData2) - 2 * labelSpace; }) 
      .attr("width", function(d) { return total(d.barData2); });

  bars.selectAll("text.malebar")
      .text(function(d) { return commas(d.barData1); })
    .transition()
      .attr("x", function(d) { return innerMargin + total(d.barData1); });
  bars.selectAll("text.femalebar")
      .text(function(d) { return commas(d.barData2); })
    .transition()
      .attr("x", function(d) { return innerMargin - total(d.barData2) - 2 * labelSpace; });
}
  $('#reload_button').live('click',function(){
      $(this).load('{% url rebuild_data %}', function(){
        location.reload();
    });
  })
{% endblock %}

{% block left %}
  {% include "ui/includes/nav_bar_doctor_statistic.html" %}
{% endblock left%}

{% block large %}
<div class="page-header">
  <h1>{% trans 'Explotación de datos' %}
    <div class="btn-group pull-right">
       <button id="reload_button" type="button" class="btn btn-info" data-loading-text="Actualizando..."><i class="icon-refresh icon-white"></i> {% trans "Actualizar datos" %}</button>
    </div>
  </h1>
</div>
 <section>
  <div id="data" style="overflow-x:scroll;">
    <table class="table table-condensed table-striped">
      <thead>
        <th>#</th>
        <th>Edad</th>
        <th>Sexo</th>
        <th>Profesión</th>
        <th>Fecha<th>
        {% for d in dimensions %}
          <td><small>Dimensión {{d.name}}</small></td>
        {% endfor %}
        {% for v in variables %}
          <td><small>{{v.name}}</small></td>
        {% endfor %}
        {% for s in status %}
          <td><small>{{s}}</small></td>
        {% endfor %}
      </thead>
      {% for r in reports %}
        <tr>
          <td>{{r.patient.id}}</td>
          <td>{{r.patient.get_age}}</td>
          <td>{{r.patient.get_sex}}</td>
          <td>{{r.patient.profession}}</td>
          <td>{{r.task.end_date|date:"j/m/Y"}}</td>
          {% for d in dimensions %}
            <td>{% dictvalue r.dimensions d.name %}</th>
          {% endfor %}
          {% for v in variables %}
            <td>{% dictvalue r.variables v.name %}</th>
          {% endfor %}
          {% for s in status %}
            <td>{% dictvalue r.status s %}</th>
          {% endfor %}
        <tr>
      {% endfor %}
    </table>
  </div>
<section>

<div id="vis"></div>
{% endblock %}



