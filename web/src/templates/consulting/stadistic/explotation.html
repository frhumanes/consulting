{% extends "ui/app.html" %}

{% load i18n %}
{% load l10n %}
{% load stadistic %}

{% block css_inline %}
  .shared, .bar, .label {
    font-size: 8pt;
    font-weight: bold;
    font-family: Arial, sans-serif;
  }
  .femalebar {
    fill: #F47777;
    }
  .malebar {
    fill: #77F4D7;
  }
  .highlight rect.malebar, .highlight rect.femalebar {
    fill: #007ACC;
  }
  text.malebar, text.femalebar {
    display: none;
  }
  .highlight text {
    display: block;
    fill: #000;
  }
  .accordion-inner {
    max-height:200px; 
    overflow-y:auto
  }

  .accordion-heading {
    font-weight: bold;
  }

  thead { display:block }
  thead th { width: 100px; }
  tbody { display:block; overflow-y:auto; overflow-x:hidden; height:200px; }
{% endblock %}

{% block css_files %}
  {{block.super}}
  <link href="{{ STATIC_URL }}css/datepicker.css" rel="stylesheet">
  <link href="{{ STATIC_URL }}css/jquery-ui-1.8.18.custom.css" rel="stylesheet"/>
{% endblock %}

{% block js_files %}
  {{ block.super }}
  <script src="http://d3js.org/d3.v2.js"></script>
  <script src="{{ STATIC_URL }}js/jquery-ui-1.8.18.custom.js"></script>
  <script src="{{ STATIC_URL }}js/bootstrap-datepicker.js"></script>
{% endblock %}

{% block jquery_init %}

$('button[type="reset"]').on('click', function(){
  var form = $(this).parentsUntil('form').parent();
  form.clearForm('.span3:hidden');
  form.find('.text-info').html('');
  form.find('input').removeAttr('checked');
});

$('#download_xls').live("click", function(e) {
    var form = $('#form');
    var orig_action = form.attr('action');
    form.attr('action', orig_action+'?as=xls');
    form.submit();
    form.attr('action', orig_action);
});

$(".range").each(function(){
    var min = $(this).find('input[id$="_0"]').attr('min');
    var max = $(this).find('input[id$="_0"]').attr('max');
    var selected_min = ($(this).find('input[id$="_0"]').val()) ? $(this).find('input[id$="_0"]').val() : min;
    var selected_max = ($(this).find('input[id$="_1"]').val()) ? $(this).find('input[id$="_1"]').val() : max;

    if ($(this).find('input[id$="_1"]').val() | $(this).find('input[id$="_0"]').val()) {
      var value = selected_min + ' - ' + selected_max;
      $(this).parentsUntil('div.stop').parent().find('.text-info').html(value);
      $(this).parent().find('.text-info').html(value);
    }

    $(this).slider({
      range: true,
      min: min,
      max: max,
      values: [eval(selected_min), eval(selected_max)],
      slide: function( event, ui ) {
          if (ui.values[0] == ui.values[1]){
            value = ui.values[0];
          } 
          else {
            value = ui.values[0] + ' - ' + ui.values[1];
          }
          $(this).parentsUntil('div.stop').parent().find('.text-info').html(value);
          $(this).parent().find('.text-info').html(value);
          $(this).find('input[id$="_0"]').val(ui.values[0]);
          $(this).find('input[id$="_1"]').val(ui.values[1]);
      }
  });
});

$('#id_date_0').datepicker().on('changeDate',
    function(ev){$('#id_date_0').datepicker('hide');
  });
$('#id_date_1').datepicker().on('changeDate',
    function(ev){$('#id_date_1').datepicker('hide');
  });

$('ul').addClass("without_decorator");

var data = [
  {% for labelname, values in data.items %}
    {% localize off %}
      {"sharedLabel": "{{labelname}}", "barData1": {% if values.1 %}{{values.1|unlocalize}}{% else %}0{% endif %}, "barData2": {% if values.2 %}{{values.2|unlocalize}}{% else %}0{% endif %}},
    {% endlocalize %}
  {% endfor %}
];

/* edit these settings freely */  
var w = 550,
    h = 500,
    topMargin = 15,
    labelSpace = 120,
    innerMargin = w/2+labelSpace,
    outerMargin = 15,
    gap = 2,
    dataRange = d3.max(data.map(function(d) { return Math.max(d.barData1, d.barData2) }));
    leftLabel = "Hombres",
    rightLabel = "Mujeres";

/* edit with care */
var chartWidth = w - innerMargin - outerMargin,
    barWidth = h / data.length,
    yScale = d3.scale.linear().domain([0, data.length]).range([0, h-topMargin]),
    total = d3.scale.linear().domain([0, dataRange]).range([0, chartWidth - labelSpace/2]),
    commas = d3.format(",.3f");

/* main panel */
var vis = d3.select("#vis").append("svg")
    .attr("width", w)
    .attr("height", h);

/* barData1 label */
vis.append("text")
  .attr("class", "label")
  .text(leftLabel)
  .attr("x", w-innerMargin)
  .attr("y", topMargin-3)
  .attr("text-anchor", "end");

/* barData2 label */
vis.append("text")
  .attr("class", "label")
  .text(rightLabel)
  .attr("x", innerMargin)
  .attr("y", topMargin-3);

/* female bars and data labels */ 
var bar = vis.selectAll("g.bar")
    .data(data)
  .enter().append("g")
    .attr("class", "bar")
    .attr("transform", function(d, i) {
      return "translate(0," + (yScale(i) + topMargin) + ")";
    });

var wholebar = bar.append("rect")
    .attr("width", w)
    .attr("height", barWidth-gap)
    .attr("fill", "none")
    .attr("pointer-events", "all");

var highlight = function(c) {
  return function(d, i) {
    bar.filter(function(d, j) {
      return i === j;
    }).attr("class", c);
  };
};

bar
  .on("mouseover", highlight("highlight bar"))
  .on("mouseout", highlight("bar"));

bar.append("rect")
    .attr("class", "femalebar")
    .attr("height", barWidth-gap);

bar.append("text")
    .attr("class", "femalebar")
    .attr("dx", -3)
    .attr("dy", "1em")
    .attr("text-anchor", "end");

bar.append("rect")
    .attr("class", "malebar")
    .attr("height", barWidth-gap)
    .attr("x", innerMargin);

bar.append("text")
    .attr("class", "malebar")
    .attr("dx", 3)
    .attr("dy", "1em");

/* sharedLabels */
bar.append("text")
    .attr("class", "shared")
    .attr("x", w/2)
    .attr("dy", "1em")
    .attr("text-anchor", "middle")
    .text(function(d) { return d.sharedLabel; });

refresh(data);

function refresh(data) {
  var bars = d3.selectAll("g.bar")
      .data(data);
  bars.selectAll("rect.malebar")
    .transition()
      .attr("width", function(d) { return total(d.barData1); });
  bars.selectAll("rect.femalebar")
    .transition()
      .attr("x", function(d) { return innerMargin - total(d.barData2) - 2 * labelSpace; }) 
      .attr("width", function(d) { return total(d.barData2); });

  bars.selectAll("text.malebar")
      .text(function(d) { return commas(d.barData1); })
    .transition()
      .attr("x", function(d) { return innerMargin + total(d.barData1); });
  bars.selectAll("text.femalebar")
      .text(function(d) { return commas(d.barData2); })
    .transition()
      .attr("x", function(d) { return innerMargin - total(d.barData2) - 2 * labelSpace; });
}
  $('#reload_button').live('click',function(){
      $(this).html('<img src="{{STATIC_URL}}/img/loading.gif" />Actualizando...');  
      $(this).addClass('disabled');
      $(this).load('{% url rebuild_data %}', function(){
        location.reload();
    });
  })
{% endblock %}

{% block left %}
  {% include "ui/includes/nav_bar_doctor_statistic.html" %}
{% endblock left%}

{% block right %}
<h4>{% trans 'Opciones de filtrado' %}</h4>
<hr>
<form class="form-inline" id="form" action="{{request.path}}" method="post" accept-charset="utf-8">
  {% csrf_token %}
  <div class="btn-group center">
    <button type="reset" class="btn btn-small">
      {% trans 'Limpiar filtros' %}
    </button>
    <button type="submit" class="btn btn-small btn-primary"><i class="icon-filter icon-white"></i>
      {% trans 'Aplicar filtros' %}
    </button>
  </div>
  <hr>
  <div class="accordion" id="accordion_filter">
  {% for f in form %}
  <div class="accordion-group stop">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion_filter" href="#collapse_{{forloop.counter}}">
      {{f.label}}
      <span class="pull-right text-info"></span>
      </a>
    </div>
    <div id="collapse_{{forloop.counter}}" class="accordion-body collapse">
      <div class="accordion-inner">
        {{f}}
      </div>
    </div>
  </div>
  {% endfor %}
  
  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion_filter" href="#collapse_variables">
      {% trans 'Variables' %}
      </a>
    </div>
    <div id="collapse_variables" class="accordion-body collapse">
      <div class="accordion-inner">
        {% for f in form.variables %}
        <div class="stop">
          <p>{{f.label|cut:"variables."}}<span class="pull-right text-info"></span></p>
          {{f.draw}}
        </div><br>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion_filter" href="#collapse_dimensions">
      {% trans 'Dimensiones' %}
      </a>
    </div>
    <div id="collapse_dimensions" class="accordion-body collapse">
      <div class="accordion-inner">
        {% for f in form.dimensions %}
        <div class="stop">
          <div>{{f.label|cut:"dimensions."}}<span class="pull-right text-info"></span></div>
          {{f.draw}}
        </div><br>
        {% endfor %}
      </div>
    </div>
  </div>
  
  </div>

</form>
{% endblock %}


{% block container %}
<div class="page-header">
  <h1>{% trans 'Explotación de datos' %}
    <div class="btn-group pull-right">
       <button id="reload_button" type="button" class="btn btn-info" data-loading-text="Actualizando..."><i class="icon-refresh icon-white"></i> {% trans "Actualizar datos" %}</button>
    </div>
  </h1>
</div>
 <section>
  
  {% if reports|length %}
  <div class="alert alert-info">La consulta devolvió <strong class="text-info">{{reports|length}}</strong> resultados</div>
  <div class="hero-unit">
    <button id="download_xls" class="btn btn-primary btn-block btn-large">{% trans 'Descargar datos en formato Excel' %}</button>
    <a href="#myModal" role="button" class="btn  btn-block" data-toggle="modal">{% trans 'Previsualizar datos' %}</a>
  </div>
  
  <div id="vis" class="center"></div>
  {% else %}
    <div class="alert alert-warning">
      <p>La consulta no devolvió <strong class="text-info">ningún</strong> resultado.</p>
      <p>Utilice criterios de filtrado menos restrictivos e inténtelo de nuevo.</p>
    </div>
  {% endif %}
<section>

<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">{% trans 'Explotación de datos' %}</h3>
  </div>
  <div class="modal-body" style="max-height: 300px; overflow: auto">
    <div id="data">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>Edad</th>
            <th>Sexo</th>
            <th>Profesión</th>
            <th>Fecha</th>
          {% for d in dimensions %}
            <td><small>Dimensión {{d.name}}</small></td>
          {% endfor %}
          {% for v in variables %}
            <td><small>{{v.name}}</small></td>
          {% endfor %}
          {% for s in status %}
            <td><small>{{s}}</small></td>
          {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for r in reports %}
          <tr>
            <td>{{r.patient.id}}</td>
            <td>{{r.age}}</td>
            <td>{{r.sex}}</td>
            <td>{{r.profession}}</td>
            <td>{{r.task.end_date|date:"j/m/Y"}}</td>
            {% for d in dimensions %}
              <td>{% dictvalue r.dimensions d.name %}</td>
            {% endfor %}
            {% for v in variables %}
              <td>{% dictvalue r.variables v.name %}</td>
            {% endfor %}
            {% for s in status %}
              <td>{% dictvalue r.status s %}</td>
            {% endfor %}
          </tr>
        {% endfor %}
          <tr>
            <th>#</th>
            <th>Edad</th>
            <th>Sexo</th>
            <th>Profesión</th>
            <th>Fecha</th>
          {% for d in dimensions %}
            <td><small>Dimensión {{d.name}}</small></td>
          {% endfor %}
          {% for v in variables %}
            <td><small>{{v.name}}</small></td>
          {% endfor %}
          {% for s in status %}
            <td><small>{{s}}</small></td>
          {% endfor %}
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">{% trans 'Cerrar' %}</button>
  </div>
</div>


{% endblock %}



