{% extends "ui/app.html" %}

{% load i18n userprofile %}

{% block js_files %}
  {{ block.super }}
  <script src="{{ STATIC_URL }}js/jquery-ui-1.9.1.custom.js"></script>
{% endblock %}

{% block css_files %}
  {{ block.super }}
  <link href="{{ STATIC_URL }}css/jquery-ui-1.9.1.custom.css" rel="stylesheet">
{% endblock %}

{% block js %}
String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
}
{% endblock %}

{% block jquery_init %}
  jQuery.ajaxSetup({
        beforeSend: function (xhr) {
              xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
              return xhr;
        }
  });
  $('#patient_list').load('{% url consulting_patient_list doctor_user_id=request.user.id %}');
  $("#searcher").autocomplete({
    minLength: 3,
    autoFocus: false,
    source: function(request, response){
              $.ajax({
                  url: '{% url consulting_patient_searcher %}',
                  type:'POST',
                  data: {
                      start: function() { return $("#searcher").val(); },
                      csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
                  },
                  dataType: "json",
                  success: function(data){
                      response(data['completed_names'])
                  }
              })
            },
    select: function(event, ui){
            var url = '/patient_management/' + ui.item.id + '/';
            $(window.location).attr('href', url);
            },
  }).data( "autocomplete" )._renderItem = function( ul, item ) {
            return $( "<li style='border-bottom: 1px solid #e0e0e0'>" )
                .data( "item.autocomplete", item )
                .append( "<a>" + item.label.replace(new RegExp( "(" + $("#searcher").val() + ")" , 'gi' ), "<strong>"+$("#searcher").val().capitalize() + "</strong>") + "<br><small class='text-info'>" + item.nif.replace($("#searcher").val(), "<strong>"+$("#searcher").val() + "</strong>") +"</small></a>" )
                .appendTo( ul );
            };
  $("#searcher").focus(); 
  $('.btn-link').on('click', function() {
    url = $(this).attr('href');
    $('#modal_patient .modal-body').load(url,'',$('#modal_patient').modal('show'));
  });

{% endblock %}

{% block left %}
  <a class="btn btn-large btn-primary" href="{% url consulting_newpatient %}"><i class="icon-plus-sign icon-white"></i> {% trans 'Nuevo Paciente' %}</a>
{% endblock %}

{% block right %}
  {% if doctors %}
  <div style="text-align: right; max-height: 400px; overflow-y: auto" class="img-polaroid">
    <ul class="nav nav-list" >
      <li class="nav-header">{% trans 'Filtrar por doctores' %}</li>
      {% for d in doctors %}
      <li><button class="btn btn-link" style="text-align: right" href="{% url consulting_patient_list d.user.id %}">{{d|name_with_title}}</button></li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
{% endblock %}

{% block container %}
<div class="page-header">
  <h1>{% trans 'Pacientes' %}
    <div class="pull-right">
      <form class="form form-inline">{% csrf_token %}
          <input type="text" id="searcher" class="input-medium search-query" style="margin: 0" placeholder="nombre, apellidos, NIF...">
      </form>
    </div>
  </h1>
</div>

<div id="patient_list" class="thumbnail">
  <div class="center">
    <img style="padding: 50px" src="{{ STATIC_URL }}/img/ajax-loader.gif" alt="loading..." />
  </div>
</div>


<div id="modal_patient" class="modal hide fade">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>{% trans 'Pacientes' %}</h3>
  </div>
  <div class="modal-body">
  </div>
  <div class="modal-footer">
    <a href="#" class="btn btn-primary" data-dismiss="modal">{% trans 'Cerrar' %}</a>
  </div>
</div>
{% endblock %}